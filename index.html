<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
    // 2. æ¥ä¸‹ä¾†æ‰æ˜¯ JavaScript çš„åˆå§‹åŒ–
    const socket = io("https://were-wolf.onrender.com");
    // ... å¾ŒçºŒä»£ç¢¼ä¿æŒä¸è®Š

// 3. å…¨åŸŸç‹€æ…‹è®Šæ•¸
let myName = "";
let amIHost = false;
let myRole = ""; 
let isAlive = true;
let currentStatus = "waiting";
let lastPlayersData = [];
let wolfStatusData = []; 
let witchPotions = { hasSave: true, hasPoison: true }; 

// 4. åŠ å…¥æˆ¿é–“é‚è¼¯
function join() {
    const rInput = document.getElementById("roomInput");
    const uInput = document.getElementById("username");
    
    if (!rInput || !uInput) return console.error("æ‰¾ä¸åˆ°è¼¸å…¥æ¬„ä½");
    
    const r = rInput.value;
    myName = uInput.value;
    
    if (r && myName && socket.connected) {
        socket.emit('joinRoom', { roomId: r, username: myName });
    } else if (!socket.connected) {
        alert("ä¼ºæœå™¨é€£ç·šä¸­ï¼Œè«‹ç¨å€™...");
    }
}

// 5. ç›£è½ä¼ºæœå™¨äº‹ä»¶
socket.on('assignRole', (role) => {
    myRole = role;
    const roleDisplay = document.getElementById("myRole");
    if (roleDisplay) {
        roleDisplay.innerText = "èº«åˆ†ï¼š" + role;
        roleDisplay.style.color = (role === 'ç‹¼äºº' ? 'var(--primary-red)' : 'var(--primary-green)');
    }
    renderList(); 
});

socket.on('updateWolfUI', (data) => {
    wolfStatusData = data;
    renderList(); 
});

socket.on('updatePlayers', ({ players, status, nightAction }) => {
    lastPlayersData = players;
    currentStatus = status;
    
    if (nightAction) {
        witchPotions.hasSave = nightAction.witchHasSave;
        witchPotions.hasPoison = nightAction.witchHasPoison;
    }

    // ä»‹é¢åˆ‡æ› (ç¢ºä¿å…ƒç´ å­˜åœ¨)
    const setupEl = document.getElementById("setup");
    const gameEl = document.getElementById("game");
    if (setupEl) setupEl.classList.add("hidden");
    if (gameEl) gameEl.classList.remove("hidden");
    
    const me = players.find(p => p.id === socket.id);
    if (me) { 
        isAlive = me.isAlive; 
        amIHost = me.isHost; 
    }

    // é»‘å¤œ/ç™½å¤©æ¨¡å¼åˆ‡æ›
    const chatInput = document.getElementById("chatInput");
    if (status.startsWith('night')) {
        document.body.classList.add("night-mode");
        if (chatInput) chatInput.disabled = true;
    } else {
        document.body.classList.remove("night-mode");
        if (chatInput) chatInput.disabled = !isAlive;
        wolfStatusData = []; 
        const sBtn = document.getElementById("skipBtn");
        if (sBtn) { sBtn.disabled = false; sBtn.innerText = "â­ï¸ è·³éç™¼è¨€"; }
    }

    const wolfSec = document.getElementById("wolfSection");
    if (wolfSec) wolfSec.classList.toggle("hidden", myRole !== 'ç‹¼äºº');
    
    renderList();
});

// 6. æ¸²æŸ“ç©å®¶åå–®èˆ‡æŒ‰éˆ•
function renderList() {
    const list = document.getElementById("playerList");
    if (!list) return;
    list.innerHTML = "";
    
    lastPlayersData.forEach(p => {
        const div = document.createElement("div");
        div.className = `player-item ${!p.isAlive ? 'dead' : ''}`;
        
        // ç‹¼äººå°ˆå±¬è¦–è¦ºåŒ–
        if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
            const myVote = wolfStatusData.find(d => d.id === socket.id);
            const isTeammateTarget = wolfStatusData.some(d => d.id !== socket.id && d.targetId === p.id);
            
            if (p.id === myVote?.targetId) div.classList.add('target-self');
            else if (isTeammateTarget) div.classList.add('target-teammate');
        }

        // é–å®šæ¨™ç±¤
        let confirmTag = "";
        if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
            const info = wolfStatusData.find(d => d.id === p.id);
            if (info?.isConfirmed) confirmTag = `<span class="confirm-tag">å·²é–å®š</span>`;
        }

        const nameClass = (myRole === 'ç‹¼äºº' && p.role === 'ç‹¼äºº') ? 'is-wolf' : '';
        let html = `<span>${p.isHost ? 'ğŸ‘‘' : ''} <span class="${nameClass}">${p.name}</span> ${confirmTag}</span><div>`;

        if (isAlive && p.isAlive) {
            if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
                html += `<button class="action-btn btn-kill" onclick="socket.emit('wolfKill','${p.id}')">é¸æ“‡</button>`;
            }
            if (currentStatus === 'night_witch' && myRole === 'å¥³å·«') {
                html += `<button class="action-btn" style="background:#27ae60" ${!witchPotions.hasSave ? 'disabled' : ''} onclick="socket.emit('witchAction',{type:'save',targetId:'${p.id}'})">æ•‘äºº</button>`;
                html += `<button class="action-btn" style="background:#c0392b" ${!witchPotions.hasPoison ? 'disabled' : ''} onclick="socket.emit('witchAction',{type:'poison',targetId:'${p.id}'})">æ¯’æ®º</button>`;
            }
            if (currentStatus === 'night_seer' && myRole === 'é è¨€å®¶' && p.id !== socket.id) {
                html += `<button class="action-btn" style="background:#8e44ad" onclick="socket.emit('checkRole','${p.id}')">æŸ¥é©—</button>`;
            }
            if (currentStatus === 'voting') {
                html += `<button class="action-btn btn-vote" onclick="socket.emit('castVote','${p.id}')">æŠ•ä»–</button>`;
            }
        }
        div.innerHTML = html + `</div>`;
        list.appendChild(div);
    });

    // ç‹¼äººå¤§æŒ‰éˆ•
    if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº' && isAlive) {
        const myInfo = wolfStatusData.find(d => d.id === socket.id);
        const cBtn = document.createElement("button");
        cBtn.className = "confirm-btn-big";
        cBtn.innerText = myInfo?.isConfirmed ? "âœ… ç­‰å¾…éšŠå‹ç¢ºèª..." : "ğŸ”’ ç¢ºèªæ“Šæ®ºç›®æ¨™";
        cBtn.disabled = !myInfo?.targetId || myInfo?.isConfirmed;
        cBtn.onclick = () => socket.emit('wolfConfirm');
        list.appendChild(cBtn);
    }
}

// 7. å…¶ä»–é€šè¨Šäº‹ä»¶
socket.on('timerUpdate', (s) => {
    const display = document.getElementById("timerDisplay");
    if (display) {
        const min = Math.floor(s/60), sec = s%60;
        display.innerText = `${min}:${sec<10?'0':''}${sec}`;
    }
});

socket.on('receiveMessage', d => {
    const b = document.getElementById("chatBox");
    if (b) {
        b.innerHTML += `<div><b style="color:#3498db">${d.name}:</b> ${d.text}</div>`;
        b.scrollTop = b.scrollHeight;
    }
});

socket.on('checkResult', m => alert(m));
socket.on('errorMessage', m => alert(m));
socket.on('gameOver', (d) => { alert("éŠæˆ²çµæŸï¼è´å®¶ï¼š" + d.winner); location.reload(); });
