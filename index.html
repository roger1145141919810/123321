<script>
    // --- ç¢ºä¿å…¨åŸŸè®Šæ•¸åˆå§‹åŒ– ---
    let wolfStatusData = []; 
    let lastPlayersData = []; 
    let currentStatus = "waiting";
    // ä¿®æ­£ï¼šè£œä¸Šç¼ºå¤±çš„åˆå§‹ç‰©ä»¶
    let witchPotions = { hasSave: true, hasPoison: true }; 
    let myRole = ""; 
    let isAlive = true;

    // --- ç›£è½èº«åˆ†åˆ†é… (ç¢ºä¿èº«åˆ†è¢«å­˜å…¥å…¨åŸŸ) ---
    socket.on('assignRole', (role) => {
        myRole = role;
        document.getElementById("myRole").innerText = "èº«åˆ†ï¼š" + role;
        document.getElementById("myRole").style.color = (role === 'ç‹¼äºº' ? 'var(--primary-red)' : 'var(--primary-green)');
        renderList(); // åˆ†é…èº«åˆ†å¾Œç«‹å³é‡ç¹ª
    });

    socket.on('updateWolfUI', (data) => {
        wolfStatusData = data;
        renderList(); 
    });

    socket.on('updatePlayers', ({ players, status, nightAction }) => {
        lastPlayersData = players;
        currentStatus = status;
        
        // ä¿®æ­£ï¼šå¾å¾Œç«¯ nightAction åŒæ­¥è—¥æ°´ç‹€æ…‹
        if (nightAction) {
            witchPotions.hasSave = nightAction.witchHasSave;
            witchPotions.hasPoison = nightAction.witchHasPoison;
        }

        const me = players.find(p => p.id === socket.id);
        if(me) { isAlive = me.isAlive; amIHost = me.isHost; }

        // åˆ‡æ›é¡¯ç¤ºæ¨¡å¼
        if(status.startsWith('night')) {
            document.body.classList.add("night-mode");
            document.getElementById("chatInput").disabled = true;
        } else {
            document.body.classList.remove("night-mode");
            document.getElementById("chatInput").disabled = !isAlive;
            wolfStatusData = []; 
            // é‡ç½®è·³éæŒ‰éˆ•
            const sBtn = document.getElementById("skipBtn");
            if (sBtn) { sBtn.disabled = false; sBtn.innerText = "â­ï¸ è·³éç™¼è¨€"; }
        }

        document.getElementById("wolfSection").classList.toggle("hidden", myRole !== 'ç‹¼äºº');
        renderList();
    });

    function renderList() {
        const list = document.getElementById("playerList");
        if (!list) return;
        list.innerHTML = "";
        
        lastPlayersData.forEach(p => {
            const div = document.createElement("div");
            div.className = `player-item ${!p.isAlive ? 'dead' : ''}`;
            
            // --- ä¿®æ­£ç‰ˆï¼šç‹¼äººç›®æ¨™æ¸²æŸ“é‚è¼¯ (æ”¯æ´å¤šç‹¼) ---
            if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
                const myVote = wolfStatusData.find(d => d.id === socket.id);
                // æª¢æŸ¥æ˜¯å¦æœ‰ã€Œä»»ä½•ã€éšŠå‹é¸äº†é€™å€‹äºº
                const isTeammateTarget = wolfStatusData.some(d => d.id !== socket.id && d.targetId === p.id);
                
                if (p.id === myVote?.targetId) {
                    div.classList.add('target-self');
                } else if (isTeammateTarget) {
                    div.classList.add('target-teammate');
                }
            }

            // é¡¯ç¤ºç¢ºèªç‹€æ…‹æ¨™ç±¤
            let confirmTag = "";
            if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
                const info = wolfStatusData.find(d => d.id === p.id);
                if (info?.isConfirmed) confirmTag = `<span class="confirm-tag">å·²é–å®š</span>`;
            }

            const nameClass = (myRole === 'ç‹¼äºº' && p.role === 'ç‹¼äºº') ? 'is-wolf' : '';
            let html = `<span>${p.isHost ? 'ğŸ‘‘' : ''} <span class="${nameClass}">${p.name}</span> ${confirmTag}</span><div>`;

            if (isAlive && p.isAlive) {
                // ç‹¼äººæŒ‰éˆ•
                if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº') {
                    html += `<button class="action-btn btn-kill" onclick="socket.emit('wolfKill','${p.id}')">é¸æ“‡</button>`;
                }
                // å¥³å·«æŒ‰éˆ•
                if (currentStatus === 'night_witch' && myRole === 'å¥³å·«') {
                    html += `<button class="action-btn" style="background:#27ae60" ${!witchPotions.hasSave ? 'disabled' : ''} onclick="socket.emit('witchAction',{type:'save',targetId:'${p.id}'})">æ•‘äºº</button>`;
                    html += `<button class="action-btn" style="background:#c0392b" ${!witchPotions.hasPoison ? 'disabled' : ''} onclick="socket.emit('witchAction',{type:'poison',targetId:'${p.id}'})">æ¯’æ®º</button>`;
                }
                // é è¨€å®¶æŒ‰éˆ•
                if (currentStatus === 'night_seer' && myRole === 'é è¨€å®¶' && p.id !== socket.id) {
                    html += `<button class="action-btn" style="background:#8e44ad" onclick="socket.emit('checkRole','${p.id}')">æŸ¥é©—</button>`;
                }
                // æŠ•ç¥¨æŒ‰éˆ•
                if (currentStatus === 'voting') {
                    html += `<button class="action-btn btn-vote" onclick="socket.emit('castVote','${p.id}')">æŠ•ä»–</button>`;
                }
            }
            div.innerHTML = html + `</div>`;
            list.appendChild(div);
        });

        // ç‹¼äººå°ˆç”¨å¤§ç¢ºèªæŒ‰éˆ•
        if (currentStatus === 'night_wolf' && myRole === 'ç‹¼äºº' && isAlive) {
            const myInfo = wolfStatusData.find(d => d.id === socket.id);
            const cBtn = document.createElement("button");
            cBtn.className = "confirm-btn-big";
            cBtn.innerText = myInfo?.isConfirmed ? "âœ… ç­‰å¾…éšŠå‹ç¢ºèª..." : "ğŸ”’ ç¢ºèªæ“Šæ®ºç›®æ¨™";
            cBtn.disabled = !myInfo?.targetId || myInfo?.isConfirmed;
            cBtn.onclick = () => socket.emit('wolfConfirm');
            list.appendChild(cBtn);
        }
    }
</script>
