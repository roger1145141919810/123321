<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸº ç‹¼äººæ®ºï¼šé€£ç·šç‰ˆ</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --primary-red: #e94560; --primary-green: #27ae60; --accent-gold: #f1c40f; }
        body { font-family: sans-serif; background: #1a1a2e; color: #e0e0e0; text-align: center; margin: 0; padding-bottom: 50px; }
        body.night-mode { background: #000; }
        section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin: 10px auto; max-width: 400px; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid transparent; }
        .player-item.dead { opacity: 0.3; filter: grayscale(1); }
        .is-wolf { color: var(--primary-red); font-weight: bold; }
        .chat-area { height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 5px; padding: 8px; font-size: 13px; text-align: left; border: 1px solid #444; margin-bottom: 5px; }
        .action-btn { padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-left: 2px; }
        .hidden { display: none !important; }
        input { background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 4px; width: 80%; margin-bottom: 10px; }
        button#startBtn { background: var(--primary-green); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button#startBtn:disabled { background: #555; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="setup">
        <section>
            <h2 style="color: var(--accent-gold);">ğŸº ç‹¼äººæ®ºé€£ç·šç³»çµ±</h2>
            <input type="text" id="roomInput" placeholder="è«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼ (ä¾‹å¦‚: 123)">
            <input type="text" id="username" placeholder="ä½ çš„æš±ç¨±">
            <button onclick="join()" style="width:85%; background:var(--primary-green); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer;">é€²å…¥æˆ¿é–“</button>
        </section>
    </div>

    <main id="game" class="hidden">
        <section>
            <div>ç›®å‰éšæ®µï¼š<span id="gamePhase" style="color:var(--accent-gold);">ç­‰å¾…ä¸­</span></div>
            <div id="myRole" style="font-size: 1.2em; margin: 10px 0;">â³ ç­‰å¾…ç™¼ç‰Œ...</div>
            <div id="timerDisplay" style="font-size: 24px; color: var(--primary-red); font-weight: bold;">--:--</div>
            <div id="nightNotice" style="color: var(--accent-gold); font-size: 14px; margin-top: 5px;"></div>
            
            <button id="startBtn" class="hidden" onclick="socket.emit('startGame')">é–‹å§‹éŠæˆ²</button>
            <button id="skipBtn" class="hidden" onclick="socket.emit('castSkipVote')" style="background:#3498db; color:white; padding:8px; border:none; border-radius:5px;">â­ï¸ è·³éç™¼è¨€</button>
        </section>

        <section id="wolfSection" class="hidden">
            <div style="color:var(--primary-red); font-size:12px; font-weight:bold;">ğŸº ç‹¼äººå¯†è«‡é »é“</div>
            <div id="wolfChatBox" class="chat-area"></div>
            <input type="text" id="wolfInput" placeholder="è¼¸å…¥æ‚„æ‚„è©±..." style="width:80%" onkeypress="if(event.key==='Enter') sendWolfChat()">
        </section>

        <section>
            <h3>ğŸ‘¥ ç©å®¶åˆ—è¡¨</h3>
            <div id="playerList"></div>
        </section>

        <section>
            <div id="chatBox" class="chat-area"></div>
            <input type="text" id="chatInput" placeholder="èªªé»ä»€éº¼å§..." style="width:80%" onkeypress="if(event.key==='Enter') send()">
        </section>
    </main>

    <script>
        // ä¼ºæœå™¨ç¶²å€éœ€èˆ‡ Render ä¸€è‡´
        const socket = io("https://were-wolf.onrender.com");
        
        let myName = "", myRole = null, amIHost = false, isAlive = true;
        let wolfStatusData = [], witchPotions = { hasSave: true, hasPoison: true };

        function join() {
            const r = document.getElementById("roomInput").value;
            myName = document.getElementById("username").value;
            if(r && myName) {
                socket.emit('joinRoom', { roomId: r, username: myName });
            } else {
                alert("è«‹å¡«å¯«æˆ¿é–“è™Ÿèˆ‡æš±ç¨±");
            }
        }

        socket.on('updatePlayers', ({ players, status, nightAction }) => {
            document.getElementById("setup").classList.add("hidden");
            document.getElementById("game").classList.remove("hidden");
            
            const me = players.find(p => p.id === socket.id);
            if(me) { 
                isAlive = me.isAlive; 
                amIHost = me.isHost; 
            }
            if(nightAction) witchPotions = { hasSave: nightAction.witchHasSave, hasPoison: nightAction.witchHasPoison };

            const phaseMap = { 'waiting':'ç­‰å¾…ä¸­', 'night_wolf':'ğŸŒ™ ç‹¼äººè«‹æ®ºäºº', 'night_witch':'ğŸ§ª å¥³å·«è«‹è¡Œå‹•', 'night_seer':'ğŸ”® é è¨€å®¶é©—äºº', 'day':'â˜€ï¸ ç™½å¤©ç™¼è¨€', 'voting':'ğŸ—³ï¸ æŠ•ç¥¨ç’°ç¯€' };
            document.getElementById("gamePhase").innerText = phaseMap[status] || 'é€²è¡Œä¸­';
            
            document.body.classList.toggle("night-mode", status.startsWith('night'));
            renderList(players, status);
        });

        socket.on('updateWolfUI', (data) => { wolfStatusData = data; });

        function renderList(players, status) {
            const list = document.getElementById("playerList");
            list.innerHTML = "";
            players.forEach(p => {
                const div = document.createElement("div");
                div.className = `player-item ${!p.isAlive ? 'dead' : ''}`;
                
                const nameClass = (myRole === 'ç‹¼äºº' && p.role === 'ç‹¼äºº') ? 'is-wolf' : '';
                let btns = `<div>`;
                if (isAlive && p.isAlive) {
                    if (status === 'night_wolf' && myRole === 'ç‹¼äºº') btns += `<button class="action-btn" style="background:#c0392b" onclick="socket.emit('wolfKill','${p.id}')">ğŸ”ª</button>`;
                    if (status === 'night_witch' && myRole === 'å¥³å·«') {
                        btns += `<button class="action-btn" style="background:#27ae60" ${!witchPotions.hasSave?'disabled':''} onclick="socket.emit('witchAction',{type:'save',targetId:'${p.id}'})">æ•‘</button>`;
                        btns += `<button class="action-btn" style="background:#c0392b" ${!witchPotions.hasPoison?'disabled':''} onclick="socket.emit('witchAction',{type:'poison',targetId:'${p.id}'})">æ¯’</button>`;
                    }
                    if (status === 'night_seer' && myRole === 'é è¨€å®¶' && p.id !== socket.id) btns += `<button class="action-btn" style="background:#8e44ad" onclick="socket.emit('checkRole','${p.id}')">ğŸ”®</button>`;
                    if (status === 'voting') btns += `<button class="action-btn" style="background:#f39c12" onclick="socket.emit('castVote','${p.id}')">æŠ•</button>`;
                }
                div.innerHTML = `<span>${p.isHost?'ğŸ‘‘':''} <span class="${nameClass}">${p.name}</span></span>${btns}</div>`;
                list.appendChild(div);
            });

            // æˆ¿ä¸»å°ˆå±¬é–‹å§‹æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯
            const startBtn = document.getElementById("startBtn");
            startBtn.classList.toggle("hidden", !amIHost || status !== 'waiting');
            if(amIHost) startBtn.disabled = players.length < 6;
            document.getElementById("skipBtn").classList.toggle("hidden", status !== 'day' || !isAlive);
        }

        function send() { 
            const i = document.getElementById("chatInput");
            if(i.value) socket.emit('sendMessage', { name: myName, text: i.value }); i.value = "";
        }
        function sendWolfChat() {
            const i = document.getElementById("wolfInput");
            if(i.value) socket.emit('sendWolfMessage', { name: myName, text: i.value }); i.value = "";
        }

        socket.on('assignRole', role => { 
            myRole = role; 
            const rDisplay = document.getElementById("myRole");
            rDisplay.innerText = "ä½ çš„èº«åˆ†ï¼š" + role; 
            rDisplay.style.color = (role === 'ç‹¼äºº' ? 'var(--primary-red)' : 'var(--primary-green)'); 
        });
        socket.on('receiveMessage', d => { const b = document.getElementById("chatBox"); b.innerHTML += `<div><b>${d.name}:</b> ${d.text}</div>`; b.scrollTop = b.scrollHeight; });
        socket.on('receiveWolfMessage', d => { const b = document.getElementById("wolfChatBox"); b.innerHTML += `<div><b>${d.name}:</b> ${d.text}</div>`; b.scrollTop = b.scrollHeight; });
        socket.on('timerUpdate', s => { document.getElementById("timerDisplay").innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; });
        socket.on('witchTarget', d => { if(myRole==='å¥³å·«') document.getElementById("nightNotice").innerText = `âš ï¸ ç³»çµ±æç¤ºï¼šæ˜¨æ™šæ­»çš„æ˜¯ ${d.name}`; });
        socket.on('checkResult', m => alert(m));
        socket.on('errorMessage', m => alert(m));
        socket.on('gameOver', d => { alert("éŠæˆ²çµæŸï¼è´å®¶ï¼š" + d.winner); location.reload(); });
    </script>
</body>
</html>
